/*
 * Copyright 2016 Palantir Technologies, Inc. All rights reserved.
 * Licensed under the BSD-3 License as modified (the “License”); you may obtain a copy
 * of the license at https://github.com/palantir/blueprint/blob/master/LICENSE
 * and https://github.com/palantir/blueprint/blob/master/PATENTS
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var classNames = require("classnames");
var React = require("react");
var Classes = require("../../common/classes");
var Errors = require("../../common/errors");
var utils_1 = require("../../common/utils");
var coreSlider_1 = require("./coreSlider");
var handle_1 = require("./handle");
var RangeEnd;
(function (RangeEnd) {
    RangeEnd[RangeEnd["LEFT"] = 0] = "LEFT";
    RangeEnd[RangeEnd["RIGHT"] = 1] = "RIGHT";
})(RangeEnd || (RangeEnd = {}));
var RangeSlider = (function (_super) {
    __extends(RangeSlider, _super);
    function RangeSlider() {
        var _this = this;
        _super.apply(this, arguments);
        this.displayName = "Blueprint.RangeSlider";
        this.className = classNames(Classes.SLIDER, Classes.RANGE_SLIDER);
        this.handles = [];
        this.addHandleRef = function (ref) {
            if (ref != null) {
                _this.handles.push(ref);
            }
        };
        this.getHandlerForIndex = function (index, callback) { return function (newValue) {
            if (utils_1.isFunction(callback)) {
                var _a = _this.props.value, leftValue = _a[0], rightValue = _a[1];
                if (index === RangeEnd.LEFT) {
                    callback([Math.min(newValue, rightValue), rightValue]);
                }
                else {
                    callback([leftValue, Math.max(newValue, leftValue)]);
                }
            }
        }; };
        this.handleChange = function (newValue) {
            var _a = _this.props.value, leftValue = _a[0], rightValue = _a[1];
            var newLeftValue = newValue[0], newRightValue = newValue[1];
            if ((leftValue !== newLeftValue || rightValue !== newRightValue) && utils_1.isFunction(_this.props.onChange)) {
                _this.props.onChange(newValue);
            }
        };
    }
    RangeSlider.prototype.renderFill = function () {
        var _a = this.props.value, leftValue = _a[0], rightValue = _a[1];
        if (leftValue === rightValue) {
            return undefined;
        }
        // expand by 1px in each direction so it sits under the handle border
        var left = Math.round((leftValue - this.props.min) * this.state.tickSize) - 1;
        var width = Math.round((rightValue - leftValue) * this.state.tickSize) + 2;
        if (width < 0) {
            left += width;
            width = Math.abs(width);
        }
        return React.createElement("div", {className: Classes.SLIDER + "-progress", style: { left: left, width: width }});
    };
    RangeSlider.prototype.renderHandles = function () {
        var _this = this;
        var _a = this.props, disabled = _a.disabled, max = _a.max, min = _a.min, onRelease = _a.onRelease, stepSize = _a.stepSize, value = _a.value;
        return value.map(function (val, index) { return (React.createElement(handle_1.Handle, {disabled: disabled, key: index, label: _this.formatLabel(val), max: max, min: min, onChange: _this.getHandlerForIndex(index, _this.handleChange), onRelease: _this.getHandlerForIndex(index, onRelease), ref: _this.addHandleRef, stepSize: stepSize, tickSize: _this.state.tickSize, value: val})); });
    };
    RangeSlider.prototype.handleTrackClick = function (event) {
        var _this = this;
        this.handles.reduce(function (min, handle) {
            // find closest handle to the mouse position
            var value = handle.clientToValue(event.clientX);
            return _this.nearestHandleForValue(value, min, handle);
        }).beginHandleMovement(event);
    };
    RangeSlider.prototype.handleTrackTouch = function (event) {
        var _this = this;
        this.handles.reduce(function (min, handle) {
            // find closest handle to the touch position
            var value = handle.clientToValue(handle.touchEventClientX(event));
            return _this.nearestHandleForValue(value, min, handle);
        }).beginHandleTouchMovement(event);
    };
    RangeSlider.prototype.nearestHandleForValue = function (value, firstHandle, secondHandle) {
        var firstDistance = Math.abs(value - firstHandle.props.value);
        var secondDistance = Math.abs(value - secondHandle.props.value);
        return secondDistance < firstDistance ? secondHandle : firstHandle;
    };
    RangeSlider.prototype.validateProps = function (props) {
        var value = props.value;
        if (value == null || value[RangeEnd.LEFT] == null || value[RangeEnd.RIGHT] == null) {
            throw new Error(Errors.RANGESLIDER_NULL_VALUE);
        }
    };
    RangeSlider.defaultProps = {
        disabled: false,
        labelStepSize: 1,
        max: 10,
        min: 0,
        showTrackFill: true,
        stepSize: 1,
        value: [0, 10],
    };
    return RangeSlider;
}(coreSlider_1.CoreSlider));
exports.RangeSlider = RangeSlider;
exports.RangeSliderFactory = React.createFactory(RangeSlider);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21wb25lbnRzL3NsaWRlci9yYW5nZVNsaWRlci50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7Ozs7Ozs7QUFFSCxJQUFZLFVBQVUsV0FBTSxZQUFZLENBQUMsQ0FBQTtBQUN6QyxJQUFZLEtBQUssV0FBTSxPQUFPLENBQUMsQ0FBQTtBQUUvQixJQUFZLE9BQU8sV0FBTSxzQkFBc0IsQ0FBQyxDQUFBO0FBQ2hELElBQVksTUFBTSxXQUFNLHFCQUFxQixDQUFDLENBQUE7QUFDOUMsc0JBQTJCLG9CQUFvQixDQUFDLENBQUE7QUFDaEQsMkJBQTZDLGNBQWMsQ0FBQyxDQUFBO0FBQzVELHVCQUF1QixVQUFVLENBQUMsQ0FBQTtBQUlsQyxJQUFLLFFBR0o7QUFIRCxXQUFLLFFBQVE7SUFDVCx1Q0FBUSxDQUFBO0lBQ1IseUNBQVMsQ0FBQTtBQUNiLENBQUMsRUFISSxRQUFRLEtBQVIsUUFBUSxRQUdaO0FBZ0JEO0lBQWlDLCtCQUE2QjtJQUE5RDtRQUFBLGlCQXFHQztRQXJHZ0MsOEJBQTZCO1FBV25ELGdCQUFXLEdBQUcsdUJBQXVCLENBQUM7UUFDdEMsY0FBUyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUU1RCxZQUFPLEdBQWEsRUFBRSxDQUFDO1FBK0R2QixpQkFBWSxHQUFHLFVBQUMsR0FBVztZQUMvQixFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDZCxLQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMzQixDQUFDO1FBQ0wsQ0FBQyxDQUFBO1FBRU8sdUJBQWtCLEdBQUcsVUFBQyxLQUFlLEVBQUUsUUFBcUMsSUFBSyxPQUFBLFVBQUMsUUFBZ0I7WUFDdEcsRUFBRSxDQUFDLENBQUMsa0JBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLElB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S0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2hFLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEUsTUFBTSxDQUFDLGNBQWMsR0FBRyxhQUFhLEdBQUcsWUFBWSxHQUFHLFdBQVcsQ0FBQztJQUN2RSxDQUFDO0lBRVMsbUNBQWEsR0FBdkIsVUFBd0IsS0FBd0I7UUFDcEMsdUJBQUssQ0FBVztRQUN4QixFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNqRixNQUFNLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBQ25ELENBQUM7SUFDTCxDQUFDO0lBMUVhLHdCQUFZLEdBQXNCO1FBQzVDLFFBQVEsRUFBRSxLQUFLO1FBQ2YsYUFBYSxFQUFFLENBQUM7UUFDaEIsR0FBRyxFQUFFLEVBQUU7UUFDUCxHQUFHLEVBQUUsQ0FBQztRQUNOLGFBQWEsRUFBRSxJQUFJO1FBQ25CLFFBQVEsRUFBRSxDQUFDO1FBQ1gsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztLQUNqQixDQUFDO0lBNEZOLGtCQUFDO0FBQUQsQ0FyR0EsQUFxR0MsQ0FyR2dDLHVCQUFVLEdBcUcxQztBQXJHWSxtQkFBVyxjQXFHdkIsQ0FBQTtBQUVZLDBCQUFrQixHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUMiLCJmaWxlIjoiY29tcG9uZW50cy9zbGlkZXIvcmFuZ2VTbGlkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTYgUGFsYW50aXIgVGVjaG5vbG9naWVzLCBJbmMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQlNELTMgTGljZW5zZSBhcyBtb2RpZmllZCAodGhlIOKAnExpY2Vuc2XigJ0pOyB5b3UgbWF5IG9idGFpbiBhIGNvcHlcbiAqIG9mIHRoZSBsaWNlbnNlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9wYWxhbnRpci9ibHVlcHJpbnQvYmxvYi9tYXN0ZXIvTElDRU5TRVxuICogYW5kIGh0dHBzOi8vZ2l0aHViLmNvbS9wYWxhbnRpci9ibHVlcHJpbnQvYmxvYi9tYXN0ZXIvUEFURU5UU1xuICovXG5cbmltcG9ydCAqIGFzIGNsYXNzTmFtZXMgZnJvbSBcImNsYXNzbmFtZXNcIjtcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gXCJyZWFjdFwiO1xuXG5pbXBvcnQgKiBhcyBDbGFzc2VzIGZyb20gXCIuLi8uLi9jb21tb24vY2xhc3Nlc1wiO1xuaW1wb3J0ICogYXMgRXJyb3JzIGZyb20gXCIuLi8uLi9jb21tb24vZXJyb3JzXCI7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi91dGlsc1wiO1xuaW1wb3J0IHsgQ29yZVNsaWRlciwgSUNvcmVTbGlkZXJQcm9wcyB9IGZyb20gXCIuL2NvcmVTbGlkZXJcIjtcbmltcG9ydCB7IEhhbmRsZSB9IGZyb20gXCIuL2hhbmRsZVwiO1xuXG5leHBvcnQgdHlwZSBOdW1iZXJSYW5nZSA9IFtudW1iZXIsIG51bWJlcl07XG5cbmVudW0gUmFuZ2VFbmQge1xuICAgIExFRlQgPSAwLFxuICAgIFJJR0hUID0gMSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUmFuZ2VTbGlkZXJQcm9wcyBleHRlbmRzIElDb3JlU2xpZGVyUHJvcHMge1xuICAgIC8qKlxuICAgICAqIFJhbmdlIHZhbHVlIG9mIHNsaWRlci4gSGFuZGxlcyB3aWxsIGJlIHJlbmRlcmVkIGF0IGVhY2ggcG9zaXRpb24gaW4gdGhlIHJhbmdlLlxuICAgICAqIEBkZWZhdWx0IFswLCAxMF1cbiAgICAgKi9cbiAgICB2YWx1ZT86IE51bWJlclJhbmdlO1xuXG4gICAgLyoqIENhbGxiYWNrIGludm9rZWQgd2hlbiB0aGUgcmFuZ2UgdmFsdWUgY2hhbmdlcy4gKi9cbiAgICBvbkNoYW5nZT8odmFsdWU6IE51bWJlclJhbmdlKTogdm9pZDtcblxuICAgIC8qKiBDYWxsYmFjayBpbnZva2VkIHdoZW4gYSBoYW5kbGUgaXMgcmVsZWFzZWQuICovXG4gICAgb25SZWxlYXNlPyh2YWx1ZTogTnVtYmVyUmFuZ2UpOiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgUmFuZ2VTbGlkZXIgZXh0ZW5kcyBDb3JlU2xpZGVyPElSYW5nZVNsaWRlclByb3BzPiB7XG4gICAgcHVibGljIHN0YXRpYyBkZWZhdWx0UHJvcHM6IElSYW5nZVNsaWRlclByb3BzID0ge1xuICAgICAgICBkaXNhYmxlZDogZmFsc2UsXG4gICAgICAgIGxhYmVsU3RlcFNpemU6IDEsXG4gICAgICAgIG1heDogMTAsXG4gICAgICAgIG1pbjogMCxcbiAgICAgICAgc2hvd1RyYWNrRmlsbDogdHJ1ZSxcbiAgICAgICAgc3RlcFNpemU6IDEsXG4gICAgICAgIHZhbHVlOiBbMCwgMTBdLFxuICAgIH07XG5cbiAgICBwdWJsaWMgZGlzcGxheU5hbWUgPSBcIkJsdWVwcmludC5SYW5nZVNsaWRlclwiO1xuICAgIHB1YmxpYyBjbGFzc05hbWUgPSBjbGFzc05hbWVzKENsYXNzZXMuU0xJREVSLCBDbGFzc2VzLlJBTkdFX1NMSURFUik7XG5cbiAgICBwcml2YXRlIGhhbmRsZXM6IEhhbmRsZVtdID0gW107XG5cbiAgICBwcm90ZWN0ZWQgcmVuZGVyRmlsbCgpIHtcbiAgICAgICAgY29uc3QgW2xlZnRWYWx1ZSwgcmlnaHRWYWx1ZV0gPSB0aGlzLnByb3BzLnZhbHVlO1xuICAgICAgICBpZiAobGVmdFZhbHVlID09PSByaWdodFZhbHVlKSB7IHJldHVybiB1bmRlZmluZWQ7IH1cbiAgICAgICAgLy8gZXhwYW5kIGJ5IDFweCBpbiBlYWNoIGRpcmVjdGlvbiBzbyBpdCBzaXRzIHVuZGVyIHRoZSBoYW5kbGUgYm9yZGVyXG4gICAgICAgIGxldCBsZWZ0ID0gTWF0aC5yb3VuZCgobGVmdFZhbHVlIC0gdGhpcy5wcm9wcy5taW4pICogdGhpcy5zdGF0ZS50aWNrU2l6ZSkgLSAxO1xuICAgICAgICBsZXQgd2lkdGggPSBNYXRoLnJvdW5kKChyaWdodFZhbHVlIC0gbGVmdFZhbHVlKSAqIHRoaXMuc3RhdGUudGlja1NpemUpICsgMjtcbiAgICAgICAgaWYgKHdpZHRoIDwgMCkge1xuICAgICAgICAgICAgbGVmdCArPSB3aWR0aDtcbiAgICAgICAgICAgIHdpZHRoID0gTWF0aC5hYnMod2lkdGgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiA8ZGl2IGNsYXNzTmFtZT17YCR7Q2xhc3Nlcy5TTElERVJ9LXByb2dyZXNzYH0gc3R5bGU9e3sgbGVmdCwgd2lkdGggfX0gLz47XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHJlbmRlckhhbmRsZXMoKSB7XG4gICAgICAgIGNvbnN0IHsgZGlzYWJsZWQsIG1heCwgbWluLCBvblJlbGVhc2UsIHN0ZXBTaXplLCB2YWx1ZSB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCgodmFsLCBpbmRleCkgPT4gKFxuICAgICAgICAgICAgPEhhbmRsZVxuICAgICAgICAgICAgICAgIGRpc2FibGVkPXtkaXNhYmxlZH1cbiAgICAgICAgICAgICAgICBrZXk9e2luZGV4fVxuICAgICAgICAgICAgICAgIGxhYmVsPXt0aGlzLmZvcm1hdExhYmVsKHZhbCl9XG4gICAgICAgICAgICAgICAgbWF4PXttYXh9XG4gICAgICAgICAgICAgICAgbWluPXttaW59XG4gICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMuZ2V0SGFuZGxlckZvckluZGV4KGluZGV4LCB0aGlzLmhhbmRsZUNoYW5nZSl9XG4gICAgICAgICAgICAgICAgb25SZWxlYXNlPXt0aGlzLmdldEhhbmRsZXJGb3JJbmRleChpbmRleCwgb25SZWxlYXNlKX1cbiAgICAgICAgICAgICAgICByZWY9e3RoaXMuYWRkSGFuZGxlUmVmfVxuICAgICAgICAgICAgICAgIHN0ZXBTaXplPXtzdGVwU2l6ZX1cbiAgICAgICAgICAgICAgICB0aWNrU2l6ZT17dGhpcy5zdGF0ZS50aWNrU2l6ZX1cbiAgICAgICAgICAgICAgICB2YWx1ZT17dmFsfVxuICAgICAgICAgICAgLz5cbiAgICAgICAgKSk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGhhbmRsZVRyYWNrQ2xpY2soZXZlbnQ6IFJlYWN0Lk1vdXNlRXZlbnQ8SFRNTEVsZW1lbnQ+KSB7XG4gICAgICAgIHRoaXMuaGFuZGxlcy5yZWR1Y2UoKG1pbiwgaGFuZGxlKSA9PiB7XG4gICAgICAgICAgICAvLyBmaW5kIGNsb3Nlc3QgaGFuZGxlIHRvIHRoZSBtb3VzZSBwb3NpdGlvblxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBoYW5kbGUuY2xpZW50VG9WYWx1ZShldmVudC5jbGllbnRYKTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm5lYXJlc3RIYW5kbGVGb3JWYWx1ZSh2YWx1ZSwgbWluLCBoYW5kbGUpO1xuICAgICAgICB9KS5iZWdpbkhhbmRsZU1vdmVtZW50KGV2ZW50KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgaGFuZGxlVHJhY2tUb3VjaChldmVudDogUmVhY3QuVG91Y2hFdmVudDxIVE1MRWxlbWVudD4pIHtcbiAgICAgICAgdGhpcy5oYW5kbGVzLnJlZHVjZSgobWluLCBoYW5kbGUpID0+IHtcbiAgICAgICAgICAgIC8vIGZpbmQgY2xvc2VzdCBoYW5kbGUgdG8gdGhlIHRvdWNoIHBvc2l0aW9uXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGhhbmRsZS5jbGllbnRUb1ZhbHVlKGhhbmRsZS50b3VjaEV2ZW50Q2xpZW50WChldmVudCkpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMubmVhcmVzdEhhbmRsZUZvclZhbHVlKHZhbHVlLCBtaW4sIGhhbmRsZSk7XG4gICAgICAgIH0pLmJlZ2luSGFuZGxlVG91Y2hNb3ZlbWVudChldmVudCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG5lYXJlc3RIYW5kbGVGb3JWYWx1ZSh2YWx1ZTogbnVtYmVyLCBmaXJzdEhhbmRsZTogSGFuZGxlLCBzZWNvbmRIYW5kbGU6IEhhbmRsZSkge1xuICAgICAgICBjb25zdCBmaXJzdERpc3RhbmNlID0gTWF0aC5hYnModmFsdWUgLSBmaXJzdEhhbmRsZS5wcm9wcy52YWx1ZSk7XG4gICAgICAgIGNvbnN0IHNlY29uZERpc3RhbmNlID0gTWF0aC5hYnModmFsdWUgLSBzZWNvbmRIYW5kbGUucHJvcHMudmFsdWUpO1xuICAgICAgICByZXR1cm4gc2Vjb25kRGlzdGFuY2UgPCBmaXJzdERpc3RhbmNlID8gc2Vjb25kSGFuZGxlIDogZmlyc3RIYW5kbGU7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHZhbGlkYXRlUHJvcHMocHJvcHM6IElSYW5nZVNsaWRlclByb3BzKSB7XG4gICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IHByb3BzO1xuICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCB8fCB2YWx1ZVtSYW5nZUVuZC5MRUZUXSA9PSBudWxsIHx8IHZhbHVlW1JhbmdlRW5kLlJJR0hUXSA9PSBudWxsKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoRXJyb3JzLlJBTkdFU0xJREVSX05VTExfVkFMVUUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRIYW5kbGVSZWYgPSAocmVmOiBIYW5kbGUpID0+IHtcbiAgICAgICAgaWYgKHJlZiAhPSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLmhhbmRsZXMucHVzaChyZWYpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRIYW5kbGVyRm9ySW5kZXggPSAoaW5kZXg6IFJhbmdlRW5kLCBjYWxsYmFjazogKHZhbHVlOiBOdW1iZXJSYW5nZSkgPT4gYW55KSA9PiAobmV3VmFsdWU6IG51bWJlcikgPT4ge1xuICAgICAgICBpZiAoaXNGdW5jdGlvbihjYWxsYmFjaykpIHtcbiAgICAgICAgICAgIGNvbnN0IFtsZWZ0VmFsdWUsIHJpZ2h0VmFsdWVdID0gdGhpcy5wcm9wcy52YWx1ZTtcbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gUmFuZ2VFbmQuTEVGVCkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKFtNYXRoLm1pbihuZXdWYWx1ZSwgcmlnaHRWYWx1ZSksIHJpZ2h0VmFsdWVdKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soW2xlZnRWYWx1ZSwgTWF0aC5tYXgobmV3VmFsdWUsIGxlZnRWYWx1ZSldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlQ2hhbmdlID0gKG5ld1ZhbHVlOiBOdW1iZXJSYW5nZSkgPT4ge1xuICAgICAgICBjb25zdCBbbGVmdFZhbHVlLCByaWdodFZhbHVlXSA9IHRoaXMucHJvcHMudmFsdWU7XG4gICAgICAgIGNvbnN0IFtuZXdMZWZ0VmFsdWUsIG5ld1JpZ2h0VmFsdWVdID0gbmV3VmFsdWU7XG4gICAgICAgIGlmICgobGVmdFZhbHVlICE9PSBuZXdMZWZ0VmFsdWUgfHwgcmlnaHRWYWx1ZSAhPT0gbmV3UmlnaHRWYWx1ZSkgJiYgaXNGdW5jdGlvbih0aGlzLnByb3BzLm9uQ2hhbmdlKSkge1xuICAgICAgICAgICAgdGhpcy5wcm9wcy5vbkNoYW5nZShuZXdWYWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCBSYW5nZVNsaWRlckZhY3RvcnkgPSBSZWFjdC5jcmVhdGVGYWN0b3J5KFJhbmdlU2xpZGVyKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
